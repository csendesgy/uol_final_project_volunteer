{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <h2>Register</h2>
    <form id="registration-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="user-type">I want to register as:</label>
            <div>
                <input type="radio" id="volunteer" name="user_type" value="volunteer" checked>
                <label for="volunteer">Volunteer</label>
                <input type="radio" id="organization" name="user_type" value="organization">
                <label for="organization">Organization</label>
            </div>
        </div>

        <!-- Organization Form -->
        <div id="organization-form" class="form-section" style="display: none;">
            <div class="form-group">
                <label for="org-profile-image">Profile Image:</label>
                <input type="file" id="org-profile-image" name="profile_image_org" accept="image/*" class="form-control">
                <img id="org-profile-preview" src="#" alt="Profile Image Preview" style="display:none; max-width: 150px; margin-top: 10px;">
            </div>

            <div class="form-row">
                <div class="col">
                    <label for="username">Username:<span style="color: red;">*</span></label>
                    <input type="text" id="username" name="username" class="form-control" data-required="true" required>
                </div>
                <div class="col">
                    <label for="org-email">Org Email:<span style="color: red;">*</span></label>
                    <input type="email" id="org-email" name="org_email" class="form-control" data-required="true" required>
                </div>
            </div>

			<div class="form-row">
				<div class="col">
					<label for="org-password">Password:<span style="color: red;">*</span></label>
					<div class="input-group">
						<input type="password" id="org-password" name="password" class="form-control" placeholder="Enter your password" data-required="true" required>
						<div class="input-group-append">
							<span class="input-group-text toggle-password" onclick="togglePasswordVisibility('org-password')">
								<i class="fas fa-eye"></i>
							</span>
						</div>
					</div>
				</div>
				<div class="col">
					<label for="org-password-confirm">Confirm Password:<span style="color: red;">*</span></label>
					<div class="input-group">
						<input type="password" id="org-password-confirm" name="password2" class="form-control" placeholder="Confirm your password" data-required="true" required>
						<div class="input-group-append">
							<span class="input-group-text toggle-password" onclick="togglePasswordVisibility('org-password-confirm')">
								<i class="fas fa-eye"></i>
							</span>
						</div>
					</div>
				</div>
			</div>


            <div class="form-row">
                <div class="col">
                    <label for="org-name">Org Name:<span style="color: red;">*</span></label>
                    <input type="text" id="org-name" name="org_name" class="form-control" data-required="true" required>
                </div>
                <div class="col">
                    <label for="org-web">Org Web:</label>
                    <input type="text" id="org-web" name="org_web" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="col">
                    <label for="org-phone">Org Phone:</label>
                    <input type="text" id="org-phone" name="org_phone" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label for="org-introduction">Org Introduction:</label>
                <textarea id="org-introduction" name="org_introduction" class="form-control"></textarea>
            </div>
        </div>

        <!-- Volunteer Form -->
        <div id="volunteer-form" class="form-section">
            <div class="form-group">
                <label for="vol-profile-image">Profile Image:</label>
                <input type="file" id="vol-profile-image" name="profile_image_vol" accept="image/*" class="form-control">
                <img id="vol-profile-preview" src="#" alt="Profile Image Preview" style="display:none; max-width: 150px; margin-top: 10px;">
            </div>

            <div class="form-row">
                <div class="col">
                    <label for="username">Username:<span style="color: red;">*</span></label>
                    <input type="text" id="username" name="username" class="form-control" data-required="true" required>
                </div>
                <div class="col">
                    <label for="email">Email:<span style="color: red;">*</span></label>
                    <input type="email" id="email" name="email" class="form-control" data-required="true" required>
                </div>
            </div>

			<div class="form-row">
				<div class="col">
					<label for="vol-password">Password:<span style="color: red;">*</span></label>
					<div class="input-group">
						<input type="password" id="vol-password" name="password" class="form-control" placeholder="Enter your password" data-required="true" required>
						<div class="input-group-append">
							<span class="input-group-text toggle-password" onclick="togglePasswordVisibility('vol-password')">
								<i class="fas fa-eye"></i>
							</span>
						</div>
					</div>
				</div>
				<div class="col">
					<label for="vol-password-confirm">Confirm Password:<span style="color: red;">*</span></label>
					<div class="input-group">
						<input type="password" id="vol-password-confirm" name="password2" class="form-control" placeholder="Confirm your password" data-required="true" required>
						<div class="input-group-append">
							<span class="input-group-text toggle-password" onclick="togglePasswordVisibility('vol-password-confirm')">
								<i class="fas fa-eye"></i>
							</span>
						</div>
					</div>
				</div>
			</div>

            <div class="form-row">
                <div class="col">
                    <label for="first-name">First Name:<span style="color: red;">*</span></label>
                    <input type="text" id="first-name" name="first_name" class="form-control" data-required="true" required>
                </div>
                <div class="col">
                    <label for="last-name">Last Name:<span style="color: red;">*</span></label>
                    <input type="text" id="last-name" name="last_name" class="form-control" data-required="true" required>
                </div>
            </div>

            <div class="form-row">
                <div class="col">
                    <label for="birth-year">Birth Year:<span style="color: red;">*</span></label>
                    <input type="number" id="birth-year" name="birth_year" class="form-control" data-required="true" required>
                </div>
				<!-- Native Language -->                
				<div class="col">
                    <label for="native-language">Native Language:<span style="color: red;">*</span></label>
					<input list="native-language-list" id="native-language" name="native_language" class="form-control" placeholder="Type or select a language" data-required="true" required>
					<datalist id="native-language-list">
						{% for language in languages %}
							<option value="{{ language.language }}">
						{% endfor %}
					</datalist>
                </div>
            </div>

            <div class="form-row">
                <div class="col">
                    <label for="phone">Phone:</label>
                    <input type="text" id="phone" name="phone" class="form-control">
                </div>
                <div class="col">
                    <label for="job-title">Job Title:</label>
                    <input type="text" id="job-title" name="job_title" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label for="vol-introduction">Introduction:</label>
                <textarea id="vol-introduction" name="vol_introduction" class="form-control"></textarea>
            </div>

			<div class="form-row slider-row">
				<div class="col">
					<label for="accept-recommendations">Accept recommendations from other volunteers?</label>
					<label class="switch">
						<input type="checkbox" id="accept-recommendations" name="accept_recommendations">
						<span class="slider round"></span>
					</label>
				</div>
				<div class="col">
					<label for="visible-for-orgs">Visible to organizations?</label>
					<label class="switch">
						<input type="checkbox" id="visible-for-orgs" name="visible_to_orgs">
						<span class="slider round"></span>
					</label>
				</div>
			</div>

			<div class="form-row slider-row">
				<div class="col">
					<label for="willing-physical-work">Willing to do light physical work? (frequently 10 lb max)</label>
					<label class="switch">
						<input type="checkbox" id="willing-physical-work" name="willing_to_light_physical">
						<span class="slider round"></span>
					</label>
				</div>

				<div class="col">
					<label for="willing-to-translate">Willing to translate?</label>
					<label class="switch">
						<input type="checkbox" id="willing-to-translate" name="willing_to_translate">
						<span class="slider round"></span>
					</label>
				</div>
			</div>

			<!-- Add Languages -->
			<div id="languages-container" class="form-group">
				<label>Additional Languages:</label>
				<button type="button" class="btn btn-secondary btn-sm" id="add-language-field">+ Add Language</button>
			</div>

			<!-- Add Skills -->
			<div id="skills-container" class="form-group">
				<label>Skills:</label>
				<button type="button" class="btn btn-secondary btn-sm" id="add-skill-field">+ Add Skill</button>
			</div>
        </div>

        <button type="submit" class="btn btn-primary">Register</button>
    </form>
</div>

<script>
	// Toggle Forms Logic
	function toggleForms() {
		const selectedUserType = document.querySelector('input[name="user_type"]:checked').value;
		const volunteerForm = document.getElementById('volunteer-form');
		const organizationForm = document.getElementById('organization-form');

		if (selectedUserType === 'volunteer') {
			// Show Volunteer Form, Hide Organization Form
			volunteerForm.style.display = 'block';
			organizationForm.style.display = 'none';

			// Disable fields in organization form
			organizationForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.disabled = true;
				field.required = false; // Ensure organization fields are not required
			});

			// Enable fields in volunteer form
			volunteerForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.disabled = false;
				if (field.hasAttribute('data-required')) {
					field.required = true; // Restore 'required' for relevant fields
				}
			});
		} else {
			// Show Organization Form, Hide Volunteer Form
			volunteerForm.style.display = 'none';
			organizationForm.style.display = 'block';

			// Disable fields in volunteer form
			volunteerForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.disabled = true;
				field.required = false; // Ensure volunteer fields are not required
			});

			// Enable fields in organization form
			organizationForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.disabled = false;
				if (field.hasAttribute('data-required')) {
					field.required = true; // Restore 'required' for relevant fields
				}
			});
		}
	}

	// Event Listeners for Toggle
	document.addEventListener("DOMContentLoaded", function () {
		// Attach change event to radio buttons
		document.querySelectorAll('input[name="user_type"]').forEach(function (el) {
			el.addEventListener('change', toggleForms);
		});
		// Call toggle logic immediately on page load
		toggleForms();
	});


    // Profile Image Preview
    ['vol', 'org'].forEach(function (type) {
        document.getElementById(`${type}-profile-image`).addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById(`${type}-profile-preview`);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    });
	
	// Add Language Fields
    document.getElementById('add-language-field').addEventListener('click', function () {
        const container = document.getElementById('languages-container');
        const languageDiv = document.createElement('div');
        languageDiv.classList.add('form-row', 'mt-2');
        languageDiv.innerHTML = `
            <div class="col">
                <input list="additional-languages-list" name="additional_languages[]" class="form-control" placeholder="Type or select a language">
                <datalist id="additional-languages-list">
                    {% for language in languages %}
                        <option value="{{ language.language }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="col">
                <select name="language_levels[]" class="form-control">
                    <option value="">Select Level</option>
                    {% for level in language_levels %}
                        <option value="{{ level.languages_level_id }}">{{ level.languages_level }}</option>
                    {% endfor %}
                </select>
            </div>
        `;
        container.appendChild(languageDiv);
    });

    // Add Skill Fields
    document.getElementById('add-skill-field').addEventListener('click', function () {
        const container = document.getElementById('skills-container');
        const skillDiv = document.createElement('div');
        skillDiv.classList.add('form-group', 'mt-2');
        skillDiv.innerHTML = `
            <input list="skills-list" name="skills[]" class="form-control" placeholder="Type or select a skill">
            <datalist id="skills-list">
                {% for skill in skills %}
                    <option value="{{ skill.skill_name }}">
                {% endfor %}
            </datalist>
        `;
        container.appendChild(skillDiv);
    });
    
    //Ensure single data point on submission
	document.getElementById('registration-form').addEventListener('submit', function (e) {
		// Determine which form is currently visible
		if (!validatePasswordMatch()) {
			e.preventDefault();
		}		

		const volunteerForm = document.getElementById('volunteer-form');
		const organizationForm = document.getElementById('organization-form');

		// If the volunteer form is visible, clear the organization form fields
		if (volunteerForm.style.display === 'block') {
			organizationForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.value = ''; // Clear value
			});
		}

		// If the organization form is visible, clear the volunteer form fields
		if (organizationForm.style.display === 'block') {
			volunteerForm.querySelectorAll('input, textarea, select').forEach(function (field) {
				field.value = ''; // Clear value
			});
		}
	});

	// Password Matching Validation
    const validatePasswordMatch = () => {
		const volunteerForm = document.getElementById('volunteer-form').style.display === 'block';
		const organizationForm = document.getElementById('organization-form').style.display === 'block';

		if (volunteerForm) {
			const password = document.getElementById('vol-password').value;
			const confirmPassword = document.getElementById('vol-password-confirm').value;
			if (password !== confirmPassword) {
				alert("Volunteer passwords do not match!");
				return false;
			}
		}

		if (organizationForm) {
			const orgPassword = document.getElementById('org-password').value;
			const orgConfirmPassword = document.getElementById('org-password-confirm').value;
			if (orgPassword !== orgConfirmPassword) {
				alert("Organization passwords do not match!");
				return false;
			}
		}

		return true;
	};

	//password visibility toggle
	function togglePasswordVisibility(fieldId) {
		const field = document.getElementById(fieldId);
		const icon = field.nextElementSibling.querySelector('i');
		if (field.type === 'password') {
			field.type = 'text';
			icon.classList.remove('fa-eye');
			icon.classList.add('fa-eye-slash');
		} else {
			field.type = 'password';
			icon.classList.remove('fa-eye-slash');
			icon.classList.add('fa-eye');
		}
	}


</script>
{% endblock %}
